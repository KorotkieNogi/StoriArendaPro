@using System.Security.Claims
@model StoriArendaPro.Models.Entities.RentalPrice
@{
    ViewData["Title"] = Model.Product.Name;
}

<div class="container py-5">
    <div class="row">
        <!-- Основная информация и изображение -->
        <div class="col-lg-6">
            <div class="card mb-4">
                <img src="@Model.Product.ImagePath" class="card-img-top product-detail-img" alt="@Model.Product.Name">
            </div>
        </div>

        <!-- Детали продукта -->
        <div class="col-lg-6">
            <h1 class="mb-3">@Model.Product.Name</h1>

            <!-- Категория и артикул -->
            <div class="d-flex mb-3">
                <span class="badge bg-primary me-2">@Model.Product.Category.Name</span>
            </div>

            <!-- Цены на аренду -->
            <div class="pricing-card mb-4">
                <h3 class="mb-3">Стоимость аренды:</h3>
                <div class="row">
                    <div class="col-md-4">
                        <div class="price-option">
                            <div class="price-label">За сутки</div>
                            <div class="price-value">@Model.PricePerDay?.ToString("N2") ₽</div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="price-option">
                            <div class="price-label">За неделю</div>
                            <div class="price-value">@Model.PricePerWeek?.ToString("N2") ₽</div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="price-option">
                            <div class="price-label">За месяц</div>
                            <div class="price-value">@Model.PricePerMonth?.ToString("N2") ₽</div>
                        </div>
                    </div>
                </div>

                <!-- Залог -->
                <div class="deposit-info mt-3">
                    <i class="fas fa-shield-alt me-2"></i> Залог: @Model.Deposit?.ToString("N2") ₽
                </div>
            </div>

            <!-- Кнопка для заявки -->
            <button class="btn btn-primary btn-lg w-100" data-bs-toggle="modal" data-bs-target="#rentalRequestModal">
                <i class="fas fa-edit me-2"></i> Оставить заявку
            </button>

            <!-- Наличие на складе -->
            <div class="availability mt-3">
                <i class="fas fa-warehouse me-2"></i>
                В наличии: <strong>@Model.Product.Inventories.FirstOrDefault()?.QuantityForRent шт.</strong>
            </div>
        </div>
    </div>

    <!-- Описание и характеристики -->
    <div class="row mt-5">
        <div class="col-12">
            <div class="card">
                <div class="card-body">
                    <ul class="nav nav-tabs" id="productTabs" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="description-tab" data-bs-toggle="tab" data-bs-target="#description" type="button" role="tab">Описание</button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="specs-tab" data-bs-toggle="tab" data-bs-target="#specs" type="button" role="tab">Характеристики</button>
                        </li>
                    </ul>

                    <div class="tab-content p-3" id="productTabsContent">
                        <div class="tab-pane fade show active" id="description" role="tabpanel">
                            <h4>Описание оборудования</h4>
                            <p>@Model.Product.Description</p>
                        </div>

                        <div class="tab-pane fade" id="specs" role="tabpanel">
                            <h4>Технические характеристики</h4>
                            <div class="row">
                                <div class="col-md-6">
                                    <ul class="list-unstyled">
                                        <li><strong>Модель:</strong> @Model.Product.Sku</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Модальное окно заявки на аренду -->
<div class="modal fade" id="rentalRequestModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Заявка на аренду</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="rentalRequestForm">
                    @if (!User.Identity.IsAuthenticated)
                    {
                        <div class="mb-3">
                            <label class="form-label">Ваше имя</label>
                            <input type="text" class="form-control" name="fullName" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Номер телефона</label>
                            <input type="tel" class="form-control phone-input" name="phone" required>
                        </div>
                    }
                    <div class="mb-3">
                        <label class="form-label">Когда вам перезвонить?</label>
                        <div class="row">
                            <div class="col-md-6">
                                <input type="date" class="form-control" name="callDate" required>
                            </div>
                            <div class="col-md-6">
                                <input type="time" class="form-control" name="callTime" required>
                            </div>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Комментарий (необязательно)</label>
                        <textarea class="form-control" name="comment" rows="3"></textarea>
                    </div>
                    <button type="submit" class="btn btn-primary w-100">Отправить заявку</button>
                </form>
            </div>
        </div>
    </div>
</div>

@section Styles {
    <style>
        .product-detail-img {
            max-height: 500px;
            object-fit: contain;
            border-radius: 10px;
        }
        
        .price-option {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            text-align: center;
            height: 100%;
        }
        
        .price-label {
            font-size: 0.9rem;
            color: #6c757d;
        }
        
        .price-value {
            font-size: 1.5rem;
            font-weight: bold;
            color: var(--primary-color);
            margin: 5px 0;
        }
        
        .deposit-info {
            background: #fff8e1;
            padding: 10px;
            border-radius: 5px;
            color: #ff6f00;
        }
        
        .availability {
            background: #e8f5e9;
            padding: 10px;
            border-radius: 5px;
            color: #2e7d32;
        }
    </style>
}

@section Scripts {
    <script>
        $(document).ready(function() {
            // Инициализация маски телефона
            $('.phone-input').inputmask('+7 (999) 999-99-99');
            
            // Установка минимальной даты для вызова (текущий день)
            $('[name="callDate"]').attr('min', new Date().toISOString().split('T')[0]);
            
            // Обработка формы заявки
            $('#rentalRequestForm').submit(function(e) {
                e.preventDefault();
                
                const formData = {
                    productId: @Model.ProductId,
                    @if (User.Identity.IsAuthenticated) {
                        <text>
                        userId: '@User.FindFirst(ClaimTypes.NameIdentifier)?.Value',
                        </text>
                    } else {
                        <text>
                        fullName: $('[name="fullName"]').val(),
                        phone: $('[name="phone"]').val(),
                        </text>
                    }
                    callDate: $('[name="callDate"]').val(),
                    callTime: $('[name="callTime"]').val(),
                    comment: $('[name="comment"]').val()
                };
                
                $.post('/Rental/CreateRequest', formData)
                    .done(function() {
                        $('#rentalRequestModal').modal('hide');
                        alert('Ваша заявка принята! Мы свяжемся с вами в указанное время.');
                    })
                    .fail(function() {
                        alert('Произошла ошибка при отправке заявки. Пожалуйста, попробуйте позже.');
                    });
            });
        });
    </script>
}